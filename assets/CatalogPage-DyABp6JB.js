import{j as e,r as c,L as P,R as C}from"./index-C9EBtYHF.js";import{g as L,a as R}from"./products-CQhE_iXr.js";import{r as A,a as M,g as O}from"./carts-M8epRVsK.js";import{u as T,a as E}from"./default-product-bY_u6-Xs.js";/* empty css                 */import{H as U}from"./Header-BUCUXpHo.js";import{G as $,P as Q,a as z}from"./Pagination-CZztWLE4.js";function D({filter:t,setFilter:d,setPage:r}){const n=m=>{d(m),r(1)};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"catalog__filter-bar",children:[e.jsx("button",{className:t==="all"?"active":"",onClick:()=>n("all"),children:"Все"}),e.jsx("button",{className:t==="new"?"active":"",onClick:()=>n("new"),children:"Сначала новые"})]})})}function G({isOpen:t,onClose:d,selectedTags:r,setSelectedTags:n}){const[m,j]=c.useState([]),[h,g]=c.useState(""),[x,l]=c.useState(!1);c.useEffect(()=>{if(!t)return;(async()=>{try{l(!0);const u=await L();j(u)}catch(u){console.error(u)}finally{l(!1)}})()},[t]);const s=a=>{r.includes(a)?n(r.filter(u=>u!==a)):n([...r,a])},p=m.filter(a=>a.tag.toLowerCase().includes(h.toLowerCase())),i=()=>{n([]),g("")};return e.jsx($,{isOpen:t,onClose:d,children:e.jsxs("div",{className:"tag-filter-modal-content",children:[e.jsx("h3",{children:"Фильтры по тегам"}),e.jsx("input",{type:"text",placeholder:"Поиск тегов...",value:h,onChange:a=>g(a.target.value)}),x?e.jsx("div",{className:"tags-loading",children:e.jsx(P,{size:40})}):e.jsx("div",{className:"tags-list",children:p.length>0?p.map(a=>e.jsxs("button",{className:r.includes(a.tag)?"active":"",onClick:()=>s(a.tag),children:[a.tag," (",a.count,")"]},a.tag)):e.jsx("p",{children:"Теги не найдены"})}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn-reset",onClick:i,children:"Сбросить фильтры"}),e.jsx("button",{onClick:d,children:"Закрыть"})]})]})})}function B({product:t,index:d,updating:r,cartItems:n,setCartItems:m,setUpdating:j}){const{user:h,loading:g}=T(),{addToast:x}=E(),l=n[t._id]||0,s=r[t._id]||!1,p=async(i,a)=>{if(!h?._id){x("Войдите, чтобы добавить товар в корзину","warning");return}try{const _=(n[i]||0)+a;if(_<0)return;j(N=>({...N,[i]:!0})),_===0?await A(i):await M(i,a),m(N=>{const b={...N};return _===0?delete b[i]:b[i]=_,b})}catch(u){console.error(u),x("Ошибка при обновлении корзины","error")}finally{j(u=>({...u,[i]:!1}))}};return e.jsxs(Q,{product:t,index:d,children:[e.jsx("p",{className:"catalog__price",children:new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB"}).format(t.price)}),e.jsx("h2",{className:"catalog__name",children:t.title}),e.jsx("p",{className:"catalog__description",children:t.description}),e.jsxs("p",{className:"catalog__owner",children:["Продавец: ",t.owner.username]}),e.jsx("div",{className:"catalog__actions",children:l===0?e.jsx("button",{className:"quantity-btn__global",onClick:()=>p(t._id,1),disabled:s,children:s||g?"...":"Добавить в корзину"}):e.jsxs("div",{className:"quantity-controls",children:[e.jsx("button",{className:"quantity-btn",onClick:()=>p(t._id,-1),disabled:s,children:"-"}),e.jsx("span",{className:"quantity-number",children:s||g?e.jsx(P,{size:40}):l}),e.jsx("button",{className:"quantity-btn",onClick:()=>p(t._id,1),disabled:s,children:"+"})]})})]})}const H=C.createContext({}),F=!0;function J({baseColor:t,highlightColor:d,width:r,height:n,borderRadius:m,circle:j,direction:h,duration:g,enableAnimation:x=F,customHighlightBackground:l}){const s={};return h==="rtl"&&(s["--animation-direction"]="reverse"),typeof g=="number"&&(s["--animation-duration"]=`${g}s`),x||(s["--pseudo-element-display"]="none"),(typeof r=="string"||typeof r=="number")&&(s.width=r),(typeof n=="string"||typeof n=="number")&&(s.height=n),(typeof m=="string"||typeof m=="number")&&(s.borderRadius=m),j&&(s.borderRadius="50%"),typeof t<"u"&&(s["--base-color"]=t),typeof d<"u"&&(s["--highlight-color"]=d),typeof l=="string"&&(s["--custom-highlight-background"]=l),s}function S({count:t=1,wrapper:d,className:r,containerClassName:n,containerTestId:m,circle:j=!1,style:h,...g}){var x,l,s;const p=C.useContext(H),i={...g};for(const[y,f]of Object.entries(g))typeof f>"u"&&delete i[y];const a={...p,...i,circle:j},u={...h,...J(a)};let _="react-loading-skeleton";r&&(_+=` ${r}`);const N=(x=a.inline)!==null&&x!==void 0?x:!1,b=[],v=Math.ceil(t);for(let y=0;y<v;y++){let f=u;if(v>t&&y===v-1){const w=(l=f.width)!==null&&l!==void 0?l:"100%",k=t%1,q=typeof w=="number"?w*k:`calc(${w} * ${k})`;f={...f,width:q}}const o=C.createElement("span",{className:_,style:f,key:y},"‌");N?b.push(o):b.push(C.createElement(C.Fragment,{key:y},o,C.createElement("br",null)))}return C.createElement("span",{className:n,"data-testid":m,"aria-live":"polite","aria-busy":(s=a.enableAnimation)!==null&&s!==void 0?s:F},d?b.map((y,f)=>C.createElement(d,{key:f},y)):b)}const K=()=>e.jsxs("div",{className:"product-card skeleton-card",children:[e.jsx(S,{height:180,borderRadius:"var(--radius)"})," ",e.jsx(S,{height:20,style:{marginTop:"0.8rem"}})," ",e.jsx(S,{height:15,width:"80%",style:{margin:"0.5rem auto"}})," ",e.jsx(S,{height:15,width:"50%",style:{margin:"0.5rem auto"}})," ",e.jsx(S,{height:36,width:"60%",style:{margin:"0.8rem auto"}})," "]}),te=()=>{const[t,d]=c.useState([]),[r,n]=c.useState(!0),[m,j]=c.useState(!1),[h,g]=c.useState([]),[x,l]=c.useState({}),[s,p]=c.useState({}),[i,a]=c.useState(1),[u,_]=c.useState(1),[N,b]=c.useState("all"),{user:v}=T(),{addToast:y}=E();return c.useEffect(()=>{(async()=>{try{n(!0);const o=await R(i,48,N,h);d(o.products),_(o.totalPages)}catch(o){console.error(o),y("Ошибка при загрузке товаров","error")}finally{n(!1)}})()},[i,N,h]),c.useEffect(()=>{(async()=>{if(v?._id)try{const o=await O(),w={};o.forEach(k=>{w[k.productId._id]=k.quantity}),l(w)}catch(o){console.error(o),y("Ошибка при загрузке корзины","error")}})()},[v]),e.jsxs(e.Fragment,{children:[e.jsx(U,{}),e.jsx("div",{className:"container",children:e.jsxs("div",{className:"catalog",children:[e.jsx("h1",{className:"catalog__title",children:"Каталог товаров"}),e.jsxs("div",{className:"catalog__controls",children:[e.jsx(D,{filter:N,setFilter:b,setPage:a}),e.jsx("button",{className:"btn-tag-filter",onClick:()=>j(!0),children:"Фильтры по тегам"})]}),e.jsx(G,{isOpen:m,onClose:()=>j(!1),selectedTags:h,setSelectedTags:g}),r?e.jsx("div",{className:"catalog__grid",children:Array.from({length:12}).map((f,o)=>e.jsx(K,{},o))}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"catalog__grid",children:t.map((f,o)=>e.jsx(B,{product:f,index:o,updating:s,cartItems:x,setCartItems:l,setUpdating:p},f._id))}),e.jsx(z,{page:i,setPage:a,totalPages:u})]})]})})]})};export{te as default};
