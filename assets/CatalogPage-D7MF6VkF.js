import{j as e,r as d,L as T,m as R,a as A,R as v}from"./index-Btt3JPxB.js";import{g as M,a as O}from"./products-iyf2QEbt.js";import{r as $,a as U,g as Q}from"./carts-B_xmIB7S.js";import{d as P,u as E,a as F}from"./default-product-DzEUPTww.js";/* empty css                 */import{H as z}from"./Header-Chv8LFnO.js";import{G as D,P as G}from"./Pagination-BdLbBim6.js";function B({filter:t,setFilter:r,setPage:i}){const n=f=>{r(f),i(1)};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"catalog__filter-bar",children:[e.jsx("button",{className:t==="all"?"active":"",onClick:()=>n("all"),children:"Все"}),e.jsx("button",{className:t==="new"?"active":"",onClick:()=>n("new"),children:"Сначала новые"})]})})}function H({isOpen:t,onClose:r,selectedTags:i,setSelectedTags:n}){const[f,j]=d.useState([]),[h,g]=d.useState(""),[y,o]=d.useState(!1);d.useEffect(()=>{if(!t)return;(async()=>{try{o(!0);const u=await M();j(u)}catch(u){console.error(u)}finally{o(!1)}})()},[t]);const a=s=>{i.includes(s)?n(i.filter(u=>u!==s)):n([...i,s])},p=f.filter(s=>s.tag.toLowerCase().includes(h.toLowerCase())),l=()=>{n([]),g("")};return e.jsx(D,{isOpen:t,onClose:r,children:e.jsxs("div",{className:"tag-filter-modal-content",children:[e.jsx("h3",{children:"Фильтры по тегам"}),e.jsx("input",{type:"text",placeholder:"Поиск тегов...",value:h,onChange:s=>g(s.target.value)}),y?e.jsx("div",{className:"tags-loading",children:e.jsx(T,{size:40})}):e.jsx("div",{className:"tags-list",children:p.length>0?p.map(s=>e.jsxs("button",{className:i.includes(s.tag)?"active":"",onClick:()=>a(s.tag),children:[s.tag," (",s.count,")"]},s.tag)):e.jsx("p",{children:"Теги не найдены"})}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn-reset",onClick:l,children:"Сбросить фильтры"}),e.jsx("button",{onClick:r,children:"Закрыть"})]})]})})}function J({product:t,index:r,children:i}){return e.jsxs(R.div,{className:"product-card",initial:{opacity:0,y:30},animate:{opacity:1,y:0},transition:{delay:r*.05,duration:.5},children:[e.jsx("img",{className:"catalog__image",src:t.image||P,alt:t.title,onError:n=>{n.target.src=P}}),e.jsx("p",{className:"catalog__price",children:new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB"}).format(t.price)}),e.jsx("h2",{className:"catalog__name",children:t.title}),i,e.jsx(A,{to:`/product/${t._id}`,className:"product-info-circle",children:"!"})]},t._id)}function K({product:t,index:r,updating:i,cartItems:n,setCartItems:f,setUpdating:j}){const{user:h,loading:g}=E(),{addToast:y}=F(),o=n[t._id]||0,a=i[t._id]||!1,p=async(l,s)=>{if(!h?._id){y("Войдите, чтобы добавить товар в корзину","warning");return}try{const b=(n[l]||0)+s;if(b<0)return;j(N=>({...N,[l]:!0})),b===0?await $(l):await U(l,s),f(N=>{const _={...N};return b===0?delete _[l]:_[l]=b,_})}catch(u){console.error(u),y("Ошибка при обновлении корзины","error")}finally{j(u=>({...u,[l]:!1}))}};return e.jsxs(J,{product:t,index:r,children:[e.jsx("p",{className:"catalog__description",children:t.description}),e.jsxs("p",{className:"catalog__owner",children:["Продавец: ",t.owner.username]}),e.jsx("div",{className:"catalog__actions",children:o===0?e.jsx("button",{className:"quantity-btn__global",onClick:()=>p(t._id,1),disabled:a,children:a||g?"...":"Добавить в корзину"}):e.jsxs("div",{className:"quantity-controls",children:[e.jsx("button",{className:"quantity-btn",onClick:()=>p(t._id,-1),disabled:a,children:"-"}),e.jsx("span",{className:"quantity-number",children:a||g?e.jsx(T,{size:40}):o}),e.jsx("button",{className:"quantity-btn",onClick:()=>p(t._id,1),disabled:a,children:"+"})]})})]})}const V=v.createContext({}),L=!0;function W({baseColor:t,highlightColor:r,width:i,height:n,borderRadius:f,circle:j,direction:h,duration:g,enableAnimation:y=L,customHighlightBackground:o}){const a={};return h==="rtl"&&(a["--animation-direction"]="reverse"),typeof g=="number"&&(a["--animation-duration"]=`${g}s`),y||(a["--pseudo-element-display"]="none"),(typeof i=="string"||typeof i=="number")&&(a.width=i),(typeof n=="string"||typeof n=="number")&&(a.height=n),(typeof f=="string"||typeof f=="number")&&(a.borderRadius=f),j&&(a.borderRadius="50%"),typeof t<"u"&&(a["--base-color"]=t),typeof r<"u"&&(a["--highlight-color"]=r),typeof o=="string"&&(a["--custom-highlight-background"]=o),a}function S({count:t=1,wrapper:r,className:i,containerClassName:n,containerTestId:f,circle:j=!1,style:h,...g}){var y,o,a;const p=v.useContext(V),l={...g};for(const[x,m]of Object.entries(g))typeof m>"u"&&delete l[x];const s={...p,...l,circle:j},u={...h,...W(s)};let b="react-loading-skeleton";i&&(b+=` ${i}`);const N=(y=s.inline)!==null&&y!==void 0?y:!1,_=[],C=Math.ceil(t);for(let x=0;x<C;x++){let m=u;if(C>t&&x===C-1){const k=(o=m.width)!==null&&o!==void 0?o:"100%",w=t%1,q=typeof k=="number"?k*w:`calc(${k} * ${w})`;m={...m,width:q}}const c=v.createElement("span",{className:b,style:m,key:x},"‌");N?_.push(c):_.push(v.createElement(v.Fragment,{key:x},c,v.createElement("br",null)))}return v.createElement("span",{className:n,"data-testid":f,"aria-live":"polite","aria-busy":(a=s.enableAnimation)!==null&&a!==void 0?a:L},r?_.map((x,m)=>v.createElement(r,{key:m},x)):_)}const X=()=>e.jsxs("div",{className:"product-card skeleton-card",children:[e.jsx(S,{height:180,borderRadius:"var(--radius)"})," ",e.jsx(S,{height:20,style:{marginTop:"0.8rem"}})," ",e.jsx(S,{height:15,width:"80%",style:{margin:"0.5rem auto"}})," ",e.jsx(S,{height:15,width:"50%",style:{margin:"0.5rem auto"}})," ",e.jsx(S,{height:36,width:"60%",style:{margin:"0.8rem auto"}})," "]}),ne=()=>{const[t,r]=d.useState([]),[i,n]=d.useState(!0),[f,j]=d.useState(!1),[h,g]=d.useState([]),[y,o]=d.useState({}),[a,p]=d.useState({}),[l,s]=d.useState(1),[u,b]=d.useState(1),[N,_]=d.useState("all"),{user:C}=E(),{addToast:x}=F();return d.useEffect(()=>{(async()=>{try{n(!0);const c=await O(l,48,N,h);r(c.products),b(c.totalPages)}catch(c){console.error(c),x("Ошибка при загрузке товаров","error")}finally{n(!1)}})()},[l,N,h]),d.useEffect(()=>{(async()=>{if(C?._id)try{const c=await Q(),k={};c.forEach(w=>{k[w.productId._id]=w.quantity}),o(k)}catch(c){console.error(c),x("Ошибка при загрузке корзины","error")}})()},[C]),e.jsxs(e.Fragment,{children:[e.jsx(z,{}),e.jsx("div",{className:"container",children:e.jsxs("div",{className:"catalog",children:[e.jsx("h1",{className:"catalog__title",children:"Каталог товаров"}),e.jsxs("div",{className:"catalog__controls",children:[e.jsx(B,{filter:N,setFilter:_,setPage:s}),e.jsx("button",{className:"btn-tag-filter",onClick:()=>j(!0),children:"Фильтры по тегам"})]}),e.jsx(H,{isOpen:f,onClose:()=>j(!1),selectedTags:h,setSelectedTags:g}),i?e.jsx("div",{className:"catalog__grid",children:Array.from({length:12}).map((m,c)=>e.jsx(X,{},c))}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"catalog__grid",children:t.map((m,c)=>e.jsx(K,{product:m,index:c,updating:a,cartItems:y,setCartItems:o,setUpdating:p},m._id))}),e.jsx(G,{page:l,setPage:s,totalPages:u})]})]})})]})};export{ne as default};
