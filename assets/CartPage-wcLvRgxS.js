import{a as v,r as c,j as r,L as _}from"./index-D13IhzE7.js";import{g as w,r as A}from"./carts-FoAozxaV.js";import{u as I,a as L,d as h}from"./default-product-Zni9HU6n.js";import{H as o}from"./Header-DpU31hYc.js";import{A as P}from"./AuthModal-DQ5tZj99.js";import"./validators-ByLOnyUC.js";const k=async()=>{try{return(await v.post("/payment/create")).data}catch(t){throw console.error("[usePaymentApi] Ошибка при создании платежа:",t.response?.data||t),t}};function H(){const{user:t}=I(),{addToast:s}=L(),[p,i]=c.useState(!1),[n,l]=c.useState([]),[x,d]=c.useState(!1),[u,m]=c.useState(!1),j=()=>i(!0),f=()=>i(!1);c.useEffect(()=>{t?.id&&y()},[t]);const y=async()=>{try{d(!0);const e=await w();l(e)}catch(e){console.error("Ошибка загрузки корзины:",e),s("Ошибка загрузки корзины","error")}finally{d(!1)}},g=async e=>{try{const a=await A(e);l(a)}catch(a){console.error("Ошибка удаления:",a),s("Ошибка удаления","error")}},N=async()=>{if(!t?.id){s("Войдите, чтобы оплатить","error");return}if(n.length===0){s("Корзина пуста","error");return}try{m(!0);const{confirmationUrl:e}=await k();if(!e){s("Не удалось создать платёж","error");return}window.location.href=e}catch(e){console.error("Ошибка оплаты:",e),s("Ошибка при создании платежа","error")}finally{m(!1)}};if(x)return r.jsxs(r.Fragment,{children:[r.jsx(o,{}),r.jsx(_,{size:160})]});if(!t)return r.jsxs(r.Fragment,{children:[r.jsx(o,{}),r.jsx("div",{className:"container",children:r.jsxs("div",{className:"cart-page",children:[r.jsx("h2",{className:"cart-title",children:"Корзина"}),r.jsx("p",{className:"cart-empty",children:"Войдите, чтобы использовать корзину"}),r.jsx("button",{className:"cart-checkout",onClick:j,children:"Войти"}),r.jsx(P,{isOpen:p,onClose:f})]})})]});const C=n.reduce((e,a)=>e+a.productId.price*a.quantity,0);return r.jsxs(r.Fragment,{children:[r.jsx(o,{}),r.jsx("div",{className:"container",children:r.jsxs("div",{className:"cart-page",children:[r.jsx("h2",{className:"cart-title",children:"Корзина"}),n.length===0?r.jsx("p",{className:"cart-empty",children:"Ваша корзина пуста"}):r.jsxs(r.Fragment,{children:[r.jsx("ul",{className:"cart-list",children:n.map(e=>r.jsxs("li",{className:"cart-item",children:[r.jsx("img",{src:e.productId.image||h,alt:e.productId.title,className:"cart-item__img",onError:a=>{a.target.src=h}}),r.jsxs("div",{className:"cart-item__info",children:[r.jsx("h4",{children:e.productId.title}),r.jsxs("p",{children:[e.quantity," ×"," ",e.productId.price," ₽"]})]}),r.jsx("button",{className:"cart-item__remove",onClick:()=>g(e.productId._id),children:"✕"})]},e.productId._id))}),r.jsxs("div",{className:"cart-summary",children:[r.jsxs("h3",{children:["Итого: ",C," ₽"]}),r.jsx("button",{className:"cart-checkout",onClick:N,disabled:u,children:u?"Обработка...":"Оплатить"})]})]})]})})]})}export{H as default};
