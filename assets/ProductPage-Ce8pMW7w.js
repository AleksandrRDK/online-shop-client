import{r as y,j as e,L as S,e as U,u as R}from"./index-DeNsLfE1.js";import{u as I,d as A,e as z}from"./products-B9NjTJRN.js";import{r as D,a as Q,g as B}from"./carts-Cm--KQFV.js";import{a as E,u as k,d as L}from"./default-product-CBJdxHHs.js";import{H}from"./Header-CxPdQDku.js";import{c as O}from"./validators-ByLOnyUC.js";import{P as q}from"./pica-CfKZxtzd.js";/* empty css                 *//* empty css                 */function M({quantity:t,cartItems:m,id:a,setCartItems:f}){const[r,s]=y.useState(!1),{addToast:i}=E(),{user:c,loading:h}=k(),w=async b=>{if(!c?.id){i("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É","warning");return}const g=(m[a]||0)+b;if(!(g<0))try{s(!0),g===0?await D(a):await Q(a,b),f(d=>{const p={...d};return g===0?delete p[a]:p[a]=g,p})}catch(d){console.error(d),i("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã","error")}finally{s(!1)}};return e.jsx(e.Fragment,{children:t===0?e.jsx("button",{className:"quantity-btn__global",onClick:()=>w(1),disabled:r,children:r||h?"...":"–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É"}):e.jsxs("div",{className:"quantity-controls",children:[e.jsx("button",{className:"quantity-btn",onClick:()=>w(-1),disabled:r,children:"-"}),e.jsx("span",{className:"quantity-number",children:r?e.jsx(S,{size:30}):t}),e.jsx("button",{className:"quantity-btn",onClick:()=>w(1),disabled:r,children:"+"})]})})}function $({product:t,editing:m,previewImg:a,cart:f}){const{id:r}=U(),{isEditing:s,editData:i,setEditData:c}=m,{preview:h,setPreview:w}=a,{quantity:b,cartItems:_,setCartItems:g}=f,{addToast:d}=E();y.useEffect(()=>{w(i.image instanceof File?URL.createObjectURL(i.image):t.image||null)},[i.image,t.image]);const p=(n,o)=>{c(u=>({...u,[n]:o}))},v=async n=>{const o=n.target.files[0];if(!o)return;const u=O(o);if(u){d(u,"error");return}try{const x=q(),j=document.createElement("img");j.src=URL.createObjectURL(o),await j.decode();const C=document.createElement("canvas"),l=512,P=Math.min(l/j.width,l/j.height,1);C.width=j.width*P,C.height=j.height*P,await x.resize(j,C);const F=await x.toBlob(C,o.type),N=new File([F],o.name,{type:o.type});c(T=>({...T,image:N})),w(URL.createObjectURL(N))}catch(x){console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞:",x),d("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É","error")}};return e.jsxs("div",{className:"product-page__header",children:[e.jsx("img",{src:h||t.image||L,alt:t.title,onError:n=>{n.target.src=L}}),e.jsx("div",{className:"product-page__info",children:s?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",value:i.title,onChange:n=>p("title",n.target.value)}),e.jsx("input",{type:"number",value:i.price,onChange:n=>p("price",n.target.value)}),e.jsx("textarea",{value:i.description,onChange:n=>p("description",n.target.value)}),e.jsx("div",{className:"product-form__image",children:e.jsx("input",{type:"file",accept:"image/*",onChange:v})}),e.jsx("input",{type:"text",value:i.tags,onChange:n=>p("tags",n.target.value)})]}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{children:t.title}),e.jsxs("p",{className:"price",children:[t.price," ‚ÇΩ"]}),e.jsx(M,{quantity:b,cartItems:_,id:r,setCartItems:g}),t.tags&&t.tags.length>0&&e.jsxs("p",{className:"tags",children:["–¢–µ–≥–∏: ",t.tags.join(", ")]}),e.jsx("p",{className:"desc",children:t.description})]})})]})}function G({characteristics:t,isEditing:m,editData:a,setEditData:f}){const r=(s,i)=>{f(c=>({...c,characteristics:{...c.characteristics,[s]:i}}))};return e.jsx(e.Fragment,{children:Object.keys(t||{}).length>0&&e.jsxs("div",{className:"product-page__characteristics",children:[e.jsx("h2",{children:"–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"}),e.jsx("table",{children:e.jsx("tbody",{children:Object.entries(m?a.characteristics:t).map(([s,i])=>e.jsxs("tr",{children:[e.jsx("td",{children:s}),e.jsx("td",{children:m?e.jsx("input",{type:"text",value:i,onChange:c=>r(s,c.target.value)}):i})]},s))})})]})})}function J({owner:t}){return e.jsxs("div",{className:"product-page__owner",children:[e.jsx("h2",{children:"–ü—Ä–æ–¥–∞–≤–µ—Ü"}),e.jsxs("p",{children:[t.username," (",t.email,")"]})]})}function K({formattedDate:t}){return e.jsx("div",{className:"product-page__date",children:e.jsxs("p",{children:["–î–æ–±–∞–≤–ª–µ–Ω–æ: ",t]})})}function V({isEditing:t,setIsEditing:m,editData:a,setEditData:f,setPreview:r,product:s,setProduct:i,setLoading:c}){const{addToast:h}=E(),w=R(),b=async()=>{c(!0);try{let d=null;if(a.image instanceof File){const n=O(a.image);if(n){h(n,"error");return}const o=q(),u=document.createElement("img");u.src=URL.createObjectURL(a.image),await u.decode();const x=document.createElement("canvas"),j=512,C=Math.min(j/u.width,j/u.height,1);x.width=u.width*C,x.height=u.height*C,await o.resize(u,x);const l=await o.toBlob(x,a.image.type);d=new File([l],a.image.name,{type:a.image.type})}const p={...a,owner:a.owner,tags:a.tags.split(",").map(n=>n.trim()).filter(n=>n)},v=await I(s._id,p,d);i(v),f({...a,image:v.image}),r(v.image||null),h("–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!","success"),m(!1)}catch(d){h("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞!","error"),console.error(d)}finally{c(!1)}},_=()=>{m(!1),f({title:s.title,price:s.price,description:s.description,tags:(s.tags||[]).join(", "),characteristics:s.characteristics||{},image:s.image,owner:s.owner?._id||s.owner}),r(s.image||null)},g=async()=>{if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?"))try{await A(s._id),h("–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω!","success"),w(-1)}catch(d){h("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞!","error"),console.error(d)}};return e.jsx("div",{className:"product-page__actions",children:t?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:b,children:"üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}),e.jsx("button",{onClick:_,children:"‚úñ –û—Ç–º–µ–Ω–∞"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>m(!0),children:"‚úè –ò–∑–º–µ–Ω–∏—Ç—å"}),e.jsx("button",{onClick:g,children:"üóë –£–¥–∞–ª–∏—Ç—å"})]})})}const ne=()=>{const{id:t}=U(),m=R(),{user:a}=k(),{addToast:f}=E(),[r,s]=y.useState(null),[i,c]=y.useState(!0),[h,w]=y.useState(null),[b,_]=y.useState({}),[g,d]=y.useState(!1),[p,v]=y.useState(null),[n,o]=y.useState({title:"",price:"",description:"",tags:"",characteristics:{},image:"",owner:null});if(y.useEffect(()=>{if(!t)return;(async()=>{try{c(!0);const l=await z(t);if(s(l),o({title:l.title,price:l.price,description:l.description,tags:(l.tags||[]).join(", "),characteristics:l.characteristics||{},image:l.image,owner:l.owner?._id||l.owner}),a?.id){const P=await B(),F={};P.forEach(N=>{F[N.productId._id]=N.quantity}),_(F)}}catch(l){w(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–∞: ${l.message}`),f("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–∞","error")}finally{c(!1)}})()},[t,a]),i)return e.jsx(S,{size:160});if(h)return e.jsx("p",{className:"status error",children:h});if(!r)return e.jsx("p",{className:"status",children:"–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"});const u=r.createdAt?new Date(r.createdAt).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):null,x=b[t]||0,j=a&&r.owner&&(r.owner._id===a.id||r.owner===a.id);return e.jsxs(e.Fragment,{children:[e.jsx(H,{}),e.jsx("div",{className:"container",children:e.jsxs("div",{className:"product-page",children:[e.jsx("button",{className:"back-btn",onClick:()=>m(-1),children:"‚Üê –ù–∞–∑–∞–¥"}),e.jsx($,{product:r,editing:{isEditing:g,editData:n,setEditData:o},previewImg:{preview:p,setPreview:v},cart:{quantity:x,cartItems:b,setCartItems:_},user:a}),e.jsx(G,{characteristics:r.characteristics,isEditing:g,editData:n,setEditData:o}),r.owner&&e.jsx(J,{owner:r.owner}),u&&e.jsx(K,{formattedDate:u}),j&&e.jsx(V,{isEditing:g,setIsEditing:d,editData:n,setEditData:o,setPreview:v,product:r,setProduct:s,setLoading:c})]})})]})};export{ne as default};
